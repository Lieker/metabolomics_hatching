---
title: "SolA barplot"
author: "Lieke Vlaar"
date: "20/10/2021"
output: html_document
---

# Necessary libraries

```{r libraries, show = FALSE, message = FALSE}
library(ggplot2)
library(tidyr)
library(dplyr)
library(tibble)
library(mdatools)
library(DESeq2)
library(vsn)
library(ggfortify)
library(RColorBrewer)
library(corrplot)
```

# Figure 1

```{r figure1}
sol <- read.csv("input/solA_conc_all.csv", header = TRUE, 
                  fileEncoding = "UTF-8-BOM")

sol2 <- sol %>% group_by(Sample, Company, selected) %>% summarize(meanconc =  mean(SolA_concentration_pmol.per.g.FW),
              stdevconc = sd(SolA_concentration_pmol.per.g.FW))


f1 <- ggplot(data = sol2, aes(x = reorder(Sample, -meanconc), y = meanconc, fill = selected)) +
  geom_bar(stat = "identity") +
  geom_errorbar(mapping=aes(x=Sample, ymin=meanconc - stdevconc, ymax=meanconc + stdevconc), width=0.5, size=0.5) +
  geom_point(data = sol, aes(x = Sample, y = SolA_concentration_pmol.per.g.FW)) +
  theme_light() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
        axis.title.x = element_blank()) +
  ylab("solA conc. pmol/g FW") +
  scale_fill_brewer(palette="Dark2")
f1
```


# Figure 2

First we need to import,  trim and filter the data
```{r importfiltertrim}
#import
exudate_pos <- read.csv("input/211124_Metabo_Exu_pos_woBlank.csv", header = TRUE, fileEncoding = "UTF-8-BOM")
exudate_neg <- read.csv("input/root_exudate_negM1.csv", header = TRUE, fileEncoding = "UTF-8-BOM")

#adapt exudate_pos to same structure as exudate_neg
fts <- names(exudate_pos)[3:length(names(exudate_pos))-1]
fts <- gsub("FT","",fts)
samples <- names(exudate_neg)[9:108]
exudate_pos <- exudate_pos[,3:3557]
names(exudate_pos) <- fts
row.names(exudate_pos) <- samples
exudate_pos <- exudate_pos %>% t() %>% as.data.frame()

#remove QC samples: are not important in dataset <500 samples
exudate_neg <- exudate_neg[,1:113]

#get xp_design file
xp_design <- read.csv("input/23gt_rootweightsolA.csv", header = TRUE, fileEncoding = "UTF-8-BOM")
compounds_exudate_neg <- exudate_neg[,1:8]
compounds_exudate_pos <- read.csv("input/211124_Feature definition.csv", header = TRUE, fileEncoding = "UTF-8-BOM") %>% rownames_to_column("sample")
compounds_exudate_pos$sample <- gsub("FT","",compounds_exudate_pos$sample)
compounds_exudate_pos <- compounds_exudate_pos %>% column_to_rownames("sample")
exudate_neg <- exudate_neg[,9:113]

#filter out compounds that have no one genotype with higher peak than 1.5x the average of empty pot samples
#make vector with 1.5x avg peak area of empty pot samples. Only necessary for negative mode because for positive this was already done
ep_n <- exudate_neg[,101:105]
ep_n$mean <- rowMeans(ep_n)
ep_n$mean1.5 <- ep_n$mean * 1.5
ep_nv <- as.vector(ep_n$mean1.5)
#make dataframe with average peak area per genotype
pergenotype <- function(x){
  x <- x %>% t() %>% as.data.frame()
  x <- x %>% rownames_to_column("sample")
  x$genotype <- substr(x$sample, 1, 3)
  x <- x[1:100,]
  x <- x %>% column_to_rownames("sample") %>% as.data.frame()
  x1 <- x %>% group_by(genotype) %>% summarise(across(everything(), mean))
  x1 <- x1 %>% column_to_rownames("genotype") %>% t() %>% as.data.frame()
  return(x1)
}
ensum <- pergenotype(x = exudate_neg)
ensum[ensum < ep_nv] <- 0
ensum <- ensum[as.logical(rowSums(ensum) != 0),]

#filter out the compounds from exudate_neg and exudate_pos that were filtered out of ensum and epsum
nc <- row.names(ensum)
nc <- gsub("V","",nc)
exudate_neg_f <- exudate_neg %>% rownames_to_column("compound")
exudate_neg_f <- exudate_neg_f[row.names(exudate_neg_f) %in% nc,]
exudate_neg_f <- exudate_neg_f %>% subset(., select = -c(compound))

#filter compounds with very low total counts (less than 10,000 in total)
exudate_neg_f2 <- exudate_neg_f[rowSums(exudate_neg_f) >10000, ]
exudate_pos_f2 <- exudate_pos

#remove empty pot (we have corrected for that)
exudate_neg_f2 <- exudate_neg_f2[,1:100]
```

Then we can correct for root weight, scale and centre
```{r Figure2}
#normalize for root weight
exudate_neg_f2t <- t(exudate_neg_f2)
rootw <- as.vector(xp_design$root.fresh.weight..g.)
exudate_neg_f2tr <- t(t(exudate_neg_f2t)) / rootw

#scale and centre
exudate_neg_f2trcs <- prep.autoscale(exudate_neg_f2tr, center = TRUE, scale = TRUE)
exudate_neg_f2trc <- prep.autoscale(exudate_neg_f2tr, center = TRUE, scale = F)
exudate_neg_f2trs <- prep.autoscale(exudate_neg_f2tr, center = F, scale = T)
boxplot(exudate_neg_f2t, main = "raw")
boxplot(exudate_neg_f2trc, main = "only centered")
boxplot(exudate_neg_f2trs, main = "only scaled")
boxplot(exudate_neg_f2trcs, main = "centered and scaled")

exudate_neg_f2trcsv <- justvsn(exudate_neg_f2trcs)
exudate_neg_f2trsv <- justvsn(exudate_neg_f2trs)
meanSdPlot(exudate_neg_f2trcs)
meanSdPlot(exudate_neg_f2trcsv)
meanSdPlot(exudate_neg_f2trs)
meanSdPlot(exudate_neg_f2trsv)
```

From these plots, it seems that centering does not make a big difference, but scaling does. Moreover, vsn transformation is very important for the heteroscedasticity.

```{r, fig.height = 6, fig.width = 8}
#check heteroscedasticity (though this is probably the same as the meanSdPlot of above)
exudate_neg_f2trcs <- as.data.frame(exudate_neg_f2trcs)
exudate_neg_f2trcs$mean <- rowMeans(as.matrix(exudate_neg_f2trcs))
exudate_neg_f2trcs$sds <- rowSds(as.matrix(exudate_neg_f2trcs))
ggplot(data = exudate_neg_f2trcs, aes(x = mean, y = sds)) +
  geom_point()
exudate_neg_f2trcs <- as.matrix(exudate_neg_f2trcs)
exudate_neg_f2trcsv2 <- as.data.frame(exudate_neg_f2trcsv)
exudate_neg_f2trcsv2$mean <- rowMeans(exudate_neg_f2trcsv2)
exudate_neg_f2trcsv2$sds <- rowSds(as.matrix(exudate_neg_f2trcsv2))
ggplot(data = exudate_neg_f2trcsv2, aes(x = mean, y = sds)) +
  geom_point()

#colours
c25 <- c(
  "dodgerblue2", "#E31A1C", # red
  "green4",
  "#6A3D9A", # purple
  "#FF7F00", # orange
  "black", "gold1",
  "skyblue2", "#FB9A99", # lt pink
  "palegreen2",
  "#CAB2D6", # lt purple
  "#FDBF6F", # lt orange
  "gray70", "khaki2",
  "maroon", "orchid1", "deeppink1", "blue1", "steelblue4",
  "darkturquoise", "green1", "yellow4", "yellow3",
  "darkorange4", "brown"
)


#remove X in names
exudate_neg_f2trcsv <- as.data.frame(exudate_neg_f2trcsv) %>% rownames_to_column("ID") 
exudate_neg_f2trcsv$ID <- gsub("X","",exudate_neg_f2trcsv$ID)
exudate_neg_f2trcsv <- exudate_neg_f2trcsv %>% column_to_rownames("ID")

#plot pca centered and scaled
pca_res <- prcomp(exudate_neg_f2trcsv, scale. = F)
exudate_neg_f2trcsv2 <- as.data.frame(cbind(exudate_neg_f2trcsv, xp_design$Genotype.name[1:100]))
names(exudate_neg_f2trcsv2)[length(names(exudate_neg_f2trcsv2))]  <- "Genotype.name"
exudate_neg_f2trcsv2$Genotype.name <- as.factor(exudate_neg_f2trcsv2$Genotype.name)
autoplot(pca_res, data = exudate_neg_f2trcsv2, colour = 'Genotype.name', label = TRUE, shape = F, label.size = 3) + theme_minimal() + scale_color_manual(values = c25) + scale_size(guide = "none")

#remove X in names
exudate_neg_f2trsv <- as.data.frame(exudate_neg_f2trsv) %>% rownames_to_column("ID") 
exudate_neg_f2trsv$ID <- gsub("X","",exudate_neg_f2trsv$ID)
exudate_neg_f2trsv <- exudate_neg_f2trsv %>% column_to_rownames("ID")

#plot pca only scaled
pca_res <- prcomp(exudate_neg_f2trsv, scale. = F)
exudate_neg_f2trsv2 <- as.data.frame(cbind(exudate_neg_f2trsv, xp_design$Genotype.name[1:100]))
names(exudate_neg_f2trsv2)[length(names(exudate_neg_f2trsv2))]  <- "Genotype.name"
exudate_neg_f2trsv2$Genotype.name <- as.factor(exudate_neg_f2trsv2$Genotype.name)
autoplot(pca_res, data = exudate_neg_f2trsv2, colour = 'Genotype.name', label = TRUE, shape = F, label.size = 3) + theme_minimal() + scale_color_manual(values = c25)
```
There is hardly any difference between only scaled and centered and scaled. We will continue with the latter since it has a slightly higher percentage explained by PC1 and PC2.

Do all of the above as well for the exudate data in the positive mode.

```{r pcaplot_pos, fig.height = 6, fig.width = 8}
#normalize for root weight
exudate_pos_f2t <- t(exudate_pos_f2)
exudate_pos_f2tr <- t(t(exudate_pos_f2t)) / rootw[1:100]

#scale and centre
exudate_pos_f2trcs <- prep.autoscale(exudate_pos_f2tr, center = TRUE, scale = TRUE)
boxplot(exudate_pos_f2trcs, main = "centered and scaled")
exudate_pos_f2trcsv <- justvsn(exudate_pos_f2trcs)
meanSdPlot(exudate_pos_f2trcs)
meanSdPlot(exudate_pos_f2trcsv)

#check heteroscedasticity (though this is probably the same as the meanSdPlot of above)
exudate_pos_f2trcs <- as.data.frame(exudate_pos_f2trcs)
exudate_pos_f2trcs$mean <- rowMeans(as.matrix(exudate_pos_f2trcs))
exudate_pos_f2trcs$sds <- rowSds(as.matrix(exudate_pos_f2trcs))
ggplot(data = exudate_pos_f2trcs, aes(x = mean, y = sds)) +
  geom_point()
exudate_pos_f2trcs <- as.matrix(exudate_pos_f2trcs)
exudate_pos_f2trcsv2 <- as.data.frame(exudate_pos_f2trcsv)
exudate_pos_f2trcsv2$mean <- rowMeans(exudate_pos_f2trcsv2)
exudate_pos_f2trcsv2$sds <- rowSds(as.matrix(exudate_pos_f2trcsv2))
ggplot(data = exudate_pos_f2trcsv2, aes(x = mean, y = sds)) +
  geom_point()

#remove X in names
exudate_pos_f2trcsv <- as.data.frame(exudate_pos_f2trcsv) %>% rownames_to_column("ID") 
exudate_pos_f2trcsv$ID <- gsub("X","",exudate_pos_f2trcsv$ID)
exudate_pos_f2trcsv <- exudate_pos_f2trcsv %>% column_to_rownames("ID")

#plot pca centered and scaled
pca_res <- prcomp(exudate_pos_f2trcsv, scale. = F)
exudate_pos_f2trcsv2 <- as.data.frame(cbind(exudate_pos_f2trcsv, xp_design$Genotype.name[1:100]))
names(exudate_pos_f2trcsv2)[length(names(exudate_pos_f2trcsv2))]  <- "Genotype.name"
exudate_pos_f2trcsv2$Genotype.name <- as.factor(exudate_pos_f2trcsv2$Genotype.name)
autoplot(pca_res, data = exudate_pos_f2trcsv2, colour = 'Genotype.name', label = TRUE, shape = F, label.size = 4.5) + theme_minimal() + scale_color_manual(values = c25) + scale_size(guide = "none")
```

Correlation plot (Figure 2) (corrected for root weight)

```{r corrplot, fig.height = 8, fig.width = 8}

#NEGATIVE MODE-------------------------------------------------------------------------------------------
forcor1 <- as.data.frame(exudate_neg_f2tr)
forcor1$solA <- xp_design$Concentration.per.g.FW[1:100]
corexun <- cor(forcor1)
corexun <- as.data.frame(corexun)
corexun <- corexun[order(-corexun$solA),]
corexun1 <- corexun[c(1:11, (length(corexun) - 9):(length(corexun))),]
rn1 <- row.names(corexun1)
corexun1 <- corexun1[, which(names(corexun1) %in% rn1)] %>% as.matrix()

#order the matrices
corexun1 <- corexun1[,order(row.names(corexun1))]
rn1 <- colnames(corexun1)
corexun1 <- corexun1[match(rn1, row.names(corexun1)),]

#change names to compoundnames
rn1 <- as.data.frame(rn1)
names(rn1) <- "rn1"
compounds_exudate_neg1 <- compounds_exudate_neg %>% rownames_to_column("rn1")
c1 <- left_join(rn1, compounds_exudate_neg1[,c("rn1","Name","m.z.meas.")], by = "rn1")
c1$m.z.meas. <- substr(c1$m.z.meas., 0, 6)

while(length(ind <- which(c1$Name == "")) > 0){
  c1$Name[ind] <- paste0("m/z ",c1$m.z.meas.[ind])
}
c1$Name[c1$rn1 == "solA"] <- "solA"
row.names(corexun1) <- c1$Name
corexun1 <- t(corexun1)
row.names(corexun1) <- c1$Name

#plot again
testRes = cor.mtest(corexun1, conf.level = 0.95)
corrplot(corexun1, 
         order = "hclust", 
         diag = F,
         addrect = 2, 
         method = "circle",
         type = "lower",
         number.cex = 0.8,
         cl.pos = 'b', 
         p.mat = testRes$p, 
         sig.level = c(0.001, 0.01, 0.05),
         insig = "label_sig",
         pch.cex = 1,
         tl.srt = 45,
         tl.col = "black",
         tl.cex = 0.8,
         col = brewer.pal(n = 10, name = 'RdYlGn'))

#POSITIVE MODE-----------------------------------------------------------------------------------------
forcor2 <- as.data.frame(exudate_pos_f2tr)
forcor2$solA <- xp_design$Concentration.per.g.FW[1:100]
corexup <- cor(forcor2)
corexup <- as.data.frame(corexup)
corexup <- corexup[order(-corexup$solA),]
corexup1 <- corexup[c(1:11, (length(corexup) - 9):(length(corexup))),]
rp1 <- row.names(corexup1)
corexup1 <- corexup1[, which(names(corexup1) %in% rp1)] %>% as.matrix()

#order the matrices
corexup1 <- corexup1[,match(rp1, colnames(corexup1))]

#change names to compoundnames
rp1 <- as.data.frame(rp1)
names(rp1) <- "rp1"
compounds_exudate_pos1 <- compounds_exudate_pos %>% rownames_to_column("rp1")
c2 <- left_join(rp1, compounds_exudate_pos1[,c("rp1","mzmed")], by = "rp1")

c2$mzmed <- substr(c2$mzmed, 1, nchar(c2$mzmed)-10)
c2$Name <- c(rep("", length(c2$rp1)))

while(length(ind <- which(c2$Name == "")) > 0){
  c2$Name[ind] <- paste0("m/z ",c2$mzmed[ind])
}
c2$Name[c2$rp1 == "solA"] <- "solA"
row.names(corexup1) <- c2$Name
corexup1 <- t(corexup1)
row.names(corexup1) <- c2$Name

#plot again
testRes = cor.mtest(corexup1, conf.level = 0.95)
corrplot(corexup1, 
         order = "hclust", 
         diag = F,
         addrect = 2, 
         method = "circle",
         type = "lower",
         number.cex = 0.8,
         cl.pos = 'b', 
         p.mat = testRes$p, 
         sig.level = c(0.001, 0.01, 0.05),
         insig = "label_sig",
         pch.cex = 1,
         tl.srt = 45,
         tl.col = "black",
         tl.cex = 0.8,
         col = brewer.pal(n = 10, name = 'RdYlGn'))
```




Correlation of hatching with unknown metabolites (not corrected for root weight)

```{r corr_hatching_vs_metabolites, fig.height = 8, fig.width = 8}
#NEGATIVE MODE-------------------------------------------------------------------------------------------

#metabolite matrix should not be normalized with root weight for hatching
exudate_neg_f2t <- as.data.frame(exudate_neg_f2t)
exudate_neg_f2t$H01 <- xp_design$Hatching[1:100]
cor_h_exun <- cor(exudate_neg_f2t) %>% as.data.frame()
cor_h_exun <- cor_h_exun[order(-cor_h_exun$H01),]
cor_h_exun <- cor_h_exun[c(1:11, (length(cor_h_exun) - 9):(length(cor_h_exun))),]
rn <- row.names(cor_h_exun)
cor_h_exun <- cor_h_exun[, which(names(cor_h_exun) %in% rn)] %>% as.matrix()

# order the matrix

rn <- colnames(cor_h_exun)
cor_h_exun <- cor_h_exun[match(rn, row.names(cor_h_exun)),]

#change names to correct names
rn <- as.data.frame(rn)
names(rn) <- "rn"
compounds_exudate_neg <- compounds_exudate_neg %>% rownames_to_column("rn")
c2 <- left_join(rn, compounds_exudate_neg[,c("rn","Name", "m.z.meas.")], by = "rn")
c2$m.z.meas. <- substr(c2$m.z.meas., 0, 6)
while(length(ind <- which(c2$Name == "")) > 0){
  c2$Name[ind] <- paste0("m/z ",c2$m.z.meas.[ind])
}
c2[17,2] <- "hatching"
row.names(cor_h_exun) <- c2$Name
names(cor_h_exun) <- c2$Name
colnames(cor_h_exun) <- c2$Name

#draw plot
testRes = cor.mtest(cor_h_exun, conf.level = 0.95)
corrplot(cor_h_exun, 
         order = "hclust", 
         diag = F,
         addrect = 2, 
         method = "circle",
         type = "lower",
         number.cex = 0.8,
         cl.pos = 'b', 
         p.mat = testRes$p, 
         sig.level = c(0.001, 0.01, 0.05),
         insig = "label_sig",
         pch.cex = 1,
         tl.srt = 45,
         tl.col = "black",
         tl.cex = 0.8,
         col = brewer.pal(n = 10, name = 'RdYlGn'))


#POSITIVE MODE------------------------------------------------------------------------------------------

#metabolite matrix should not be normalized with root weight for hatching
exudate_pos_f2t <- as.data.frame(exudate_pos_f2t)
exudate_pos_f2t$H01 <- xp_design$Hatching[1:100]
cor_h_exup <- cor(exudate_pos_f2t) %>% as.data.frame()
cor_h_exup <- cor_h_exup[order(-cor_h_exup$H01),]
cor_h_exup <- cor_h_exup[c(1:11, (length(cor_h_exup) - 9):(length(cor_h_exup))),]
rp <- as.vector(rownames(cor_h_exup))
cor_h_exup <- cor_h_exup[, which(colnames(cor_h_exup) %in% rp)] %>% as.matrix()

# order the matrix
cor_h_exup <- as.data.frame(cor_h_exup[rp, rp])

#change names to correct names
rp <- as.data.frame(rp)
names(rp) <- "rp"
compounds_exudate_pos1 <- compounds_exudate_pos %>% rownames_to_column("rp")
c3 <- left_join(rp, compounds_exudate_pos1[,c("rp","mzmed")], by = "rp")

c3$mzmed <- round(c3$mzmed, digits = 2)
c3$Name <- c(rep("", length(c3$rp)))

while(length(ind <- which(c3$Name == "")) > 0){
  c3$Name[ind] <- paste0("m/z ",c3$mzmed[ind])
}
c3$Name[c3$rp == "H01"] <- "hatching"
row.names(cor_h_exup) <- c3$Name
cor_h_exup <- t(cor_h_exup)
row.names(cor_h_exup) <- c3$Name

#draw plot
testRes = cor.mtest(cor_h_exup, conf.level = 0.95)
corrplot(cor_h_exup, 
         order = "alphabet", 
         diag = F,
         addrect = 2, 
         method = "circle",
         type = "lower",
         number.cex = 0.8,
         cl.pos = 'b', 
         p.mat = testRes$p, 
         sig.level = c(0.001, 0.01, 0.05),
         insig = "label_sig",
         pch.cex = 1,
         tl.srt = 45,
         tl.col = "black",
         tl.cex = 0.8,
         col = brewer.pal(n = 10, name = 'RdYlGn'))
```

# Root extracts (Figure 3)

First import and trim
```{r import transform}
extract_pos <- read.csv("input/root_extract_posM1.csv", header = TRUE, fileEncoding = "UTF-8-BOM")
extract_neg <- read.csv("input/root_extract_negM1.csv", header = TRUE, fileEncoding = "UTF-8-BOM")
extract_pos <- extract_pos[,1:106]
extract_neg <- extract_neg[,2:107]

compounds_extract_pos <- extract_pos[,1:8]
compounds_extract_neg <- extract_neg[,1:8]
extract_pos <- extract_pos[,9:ncol(extract_pos)]
extract_neg <- extract_neg[,9:ncol(extract_neg)]

#filter compounds with very low total counts (less than 100,000 in total)
extract_pos_f <- extract_pos[rowSums(extract_pos) >50000, ]
extract_neg_f <- extract_neg[rowSums(extract_neg) >50000, ]
```


Then correct for root weight, scale and centre:
```{r Figure2}
#extract only useful rows from xp_design
samples_extracts <- colnames(extract_pos)
samples_extracts <- gsub("X","",samples_extracts)
xp_design_extracts <- xp_design[xp_design$Number %in% samples_extracts,]
rootw_extracts <- xp_design$root.fresh.weight..g.

#normalize for root weight
extract_pos_ft <- t(extract_pos_f)
extract_pos_ftr <- t(t(extract_pos_ft)) / rootw_extracts
extract_neg_ft <- t(extract_neg_f)
extract_neg_ftr <- t(t(extract_neg_ft)) / rootw_extracts

#scale and centre
extract_pos_ftrcs <- prep.autoscale(extract_pos_ftr, center = TRUE, scale = TRUE)
extract_pos_ftrc <- prep.autoscale(extract_pos_ftr, center = TRUE, scale = F)
extract_pos_ftrs <- prep.autoscale(extract_pos_ftr, center = F, scale = T)
boxplot(extract_pos_ftr, main = "raw")
boxplot(extract_pos_ftrc, main = "only centered")
boxplot(extract_pos_ftrs, main = "only scaled")
boxplot(extract_pos_ftrcs, main = "centered and scaled")

extract_pos_ftrcsv <- justvsn(extract_pos_ftrcs)
extract_pos_ftrsv <- justvsn(extract_pos_ftrs)
meanSdPlot(extract_pos_ftrcs)
meanSdPlot(extract_pos_ftrcsv)
meanSdPlot(extract_pos_ftrs)
meanSdPlot(extract_pos_ftrsv)

#check heteroscedasticity (though this is probably the same as the meanSdPlot of above)
extract_pos_ftrcs <- as.data.frame(extract_pos_ftrcs)
extract_pos_ftrcs$mean <- rowMeans(as.matrix(extract_pos_ftrcs))
extract_pos_ftrcs$sds <- rowSds(as.matrix(extract_pos_ftrcs))
ggplot(data = extract_pos_ftrcs, aes(x = mean, y = sds)) +
  geom_point()
extract_pos_ftrcs <- as.matrix(extract_pos_ftrcs)
extract_pos_ftrcsv2 <- as.data.frame(extract_pos_ftrcsv)
extract_pos_ftrcsv2$mean <- rowMeans(extract_pos_ftrcsv2)
extract_pos_ftrcsv2$sds <- rowSds(as.matrix(extract_pos_ftrcsv2))
ggplot(data = extract_pos_ftrcsv2, aes(x = mean, y = sds)) +
  geom_point()
```

Plot PCA
```{r, fig.height = 6, fig.width = 8}
#remove X in names
extract_pos_ftrcsv <- as.data.frame(extract_pos_ftrcsv) %>% rownames_to_column("ID") 
extract_pos_ftrcsv$ID <- gsub("X","",extract_pos_ftrcsv$ID)
extract_pos_ftrcsv <- extract_pos_ftrcsv %>% column_to_rownames("ID")

#plot pca centered and scaled
pca_res <- prcomp(extract_pos_ftrcsv, scale. = F)
extract_pos_ftrcsv2 <- as.data.frame(cbind(extract_pos_ftrcsv, xp_design_extracts$Genotype.name))
names(extract_pos_ftrcsv2)[length(names(extract_pos_ftrcsv2))]  <- "Genotype.name"
extract_pos_ftrcsv2$Genotype.name <- as.factor(extract_pos_ftrcsv2$Genotype.name)
autoplot(pca_res, data = extract_pos_ftrcsv2, colour = 'Genotype.name', label = TRUE, shape = F, label.size = 3) + theme_minimal() + scale_color_manual(values = c25) + scale_size(guide = "none")
```

Also do transformations and pca plot for negative mode

```{r Figure3, fig.height = 6, fig.width = 8}
#scale and centre
extract_neg_ftrcs <- prep.autoscale(extract_neg_ftr, center = TRUE, scale = TRUE)
boxplot(extract_neg_ftrcs, main = "centered and scaled")

extract_neg_ftrcsv <- justvsn(extract_neg_ftrcs)
meanSdPlot(extract_neg_ftrcs)
meanSdPlot(extract_neg_ftrcsv)

#check heteroscedasticity (though this is probably the same as the meanSdPlot of above)
extract_neg_ftrcs <- as.data.frame(extract_neg_ftrcs)
extract_neg_ftrcs$mean <- rowMeans(as.matrix(extract_neg_ftrcs))
extract_neg_ftrcs$sds <- rowSds(as.matrix(extract_neg_ftrcs))
ggplot(data = extract_neg_ftrcs, aes(x = mean, y = sds)) +
  geom_point()
extract_neg_ftrcs <- as.matrix(extract_neg_ftrcs)
extract_neg_ftrcsv2 <- as.data.frame(extract_neg_ftrcsv)
extract_neg_ftrcsv2$mean <- rowMeans(extract_neg_ftrcsv2)
extract_neg_ftrcsv2$sds <- rowSds(as.matrix(extract_neg_ftrcsv2))
ggplot(data = extract_neg_ftrcsv2, aes(x = mean, y = sds)) +
  geom_point()

#remove X in names
extract_neg_ftrcsv <- as.data.frame(extract_neg_ftrcsv) %>% rownames_to_column("ID") 
extract_neg_ftrcsv$ID <- gsub("X","",extract_neg_ftrcsv$ID)
extract_neg_ftrcsv <- extract_neg_ftrcsv %>% column_to_rownames("ID")

#plot pca centered and scaled
pca_res <- prcomp(extract_neg_ftrcsv, scale. = F)
extract_neg_ftrcsv2 <- as.data.frame(cbind(extract_neg_ftrcsv, xp_design_extracts$Genotype.name))
names(extract_neg_ftrcsv2)[length(names(extract_neg_ftrcsv2))]  <- "Genotype.name"
extract_neg_ftrcsv2$Genotype.name <- as.factor(extract_neg_ftrcsv2$Genotype.name)
autoplot(pca_res, data = extract_neg_ftrcsv2, colour = 'Genotype.name', label = TRUE, shape = F, label.size = 3) + theme_minimal() + scale_color_manual(values = c25) + scale_size(guide = "none")
```

## correlation plots

```{r corrplot, fig.height = 8, fig.width = 8}
#POSITIVE MODE-------------------------------------------------------------------------------------------
forcor4 <- as.data.frame(extract_pos_ftr)
forcor4$solA <- xp_design_extracts$Concentration.per.g.FW
corextp <- cor(forcor4)
corextp <- as.data.frame(corextp)
corextp <- corextp[order(-corextp$solA),]
corextp_f <- corextp[c(1:11, (length(corextp) - 9):(length(corextp))),]
rp <- row.names(corextp_f)
corextp_f <- corextp_f[, which(names(corextp_f) %in% rp)] %>% as.matrix()

#order the matrices
corextp_f <- as.data.frame(corextp_f[rp, rp])

#change names to compoundnames
rp <- as.data.frame(rp)
names(rp) <- "rp"
compounds_extract_pos1 <- compounds_extract_pos %>% rownames_to_column("rp")
c4 <- left_join(rp, compounds_extract_pos1[,c("rp","Name","m.z.meas.")], by = "rp")
c4$m.z.meas. <- substr(c4$m.z.meas., 0, 6)

while(length(ind <- which(c4$Name == "")) > 0){
  c4$Name[ind] <- paste0("m/z ",c4$m.z.meas.[ind])
}
c4$Name[c4$rp == "solA"] <- "solA"
row.names(corextp_f) <- c4$Name
corextp_f <- t(corextp_f)
row.names(corextp_f) <- c4$Name

#plot again
testRes = cor.mtest(corextp_f, conf.level = 0.95)
corrplot(corextp_f, 
         order = "hclust", 
         diag = F,
         addrect = 2, 
         method = "circle",
         type = "lower",
         number.cex = 0.8,
         cl.pos = 'b', 
         p.mat = testRes$p, 
         sig.level = c(0.001, 0.01, 0.05),
         insig = "label_sig",
         pch.cex = 1,
         tl.srt = 45,
         tl.col = "black",
         tl.cex = 0.8,
         col = brewer.pal(n = 10, name = 'RdYlGn'))

#NEGATIVE MODE-----------------------------------------------------------------------------------------
forcor5 <- as.data.frame(extract_neg_ftr)
forcor5$solA <- xp_design_extracts$Concentration.per.g.FW
corextn <- cor(forcor5)
corextn <- as.data.frame(corextn)
corextn <- corextn[order(-corextn$solA),]
corextn_f <- corextn[c(1:11, (length(corextn) - 9):(length(corextn))),]
rn <- row.names(corextn_f)
corextn_f <- corextn_f[, which(names(corextn_f) %in% rn)] %>% as.matrix()

#order the matrices
corextn_f <- as.data.frame(corextn_f[rn, rn])

#change names to compoundnames
rn <- as.data.frame(rn)
names(rn) <- "rn"
compounds_extract_neg1 <- compounds_extract_neg %>% rownames_to_column("rn")
c5 <- left_join(rn, compounds_extract_neg1[,c("rn","Name","m.z.meas.")], by = "rn")
c5$m.z.meas. <- substr(c5$m.z.meas., 0, 6)

while(length(ind <- which(c5$Name == "")) > 0){
  c5$Name[ind] <- paste0("m/z ",c5$m.z.meas.[ind])
}
c5$Name[c5$rn == "solA"] <- "solA"
dup <- c5$rn[duplicated(c5$Name)]
c5 <- c5[!c5$rn == dup,]
corextn_f <- corextn_f[!rownames(corextn_f) %in% dup, !colnames(corextn_f) %in% dup]
row.names(corextn_f) <- c5$Name
corextn_f <- t(corextn_f)
row.names(corextn_f) <- c5$Name

#plot again
testRes = cor.mtest(corextn_f, conf.level = 0.95)
corrplot(as.matrix(corextn_f), 
         order = "hclust", 
         diag = F,
         addrect = 2, 
         method = "circle",
         type = "lower",
         number.cex = 0.8,
         cl.pos = 'b', 
         p.mat = testRes$p, 
         sig.level = c(0.001, 0.01, 0.05),
         insig = "label_sig",
         pch.cex = 1,
         tl.srt = 45,
         tl.col = "black",
         tl.cex = 0.8,
         col = brewer.pal(n = 10, name = 'RdYlGn'))
```

```{r corr_hatching_vs_metabolites, fig.height = 8, fig.width = 8}
#POSITIVE MODE-------------------------------------------------------------------------------------------

#metabolite matrix should NOT be normalized with root weight for hatching
extract_pos_ft <- as.data.frame(extract_pos_ft)
extract_pos_ft$H01 <- xp_design_extracts$Hatching
corhextp <- cor(extract_pos_ft) %>% as.data.frame()
corhextp <- corhextp[order(-corhextp$H01),]
corhextp_f <- corhextp[c(1:11, (length(corhextp) - 9):(length(corhextp))),]
rph <- row.names(corhextp_f)
corhextp_f <- corhextp_f[, which(names(corhextp_f) %in% rph)] %>% as.matrix()

# order the matrix
corhextp_f <- as.data.frame(corhextp_f[rph, rph])

#change names to correct names
rph <- as.data.frame(rph)
names(rph) <- "rph"
compounds_extract_pos1 <- compounds_extract_pos %>% rownames_to_column("rph")
c6 <- left_join(rph, compounds_extract_pos1[,c("rph","Name", "m.z.meas.")], by = "rph")
c6$m.z.meas. <- substr(c6$m.z.meas., 0, 6)
while(length(ind <- which(c6$Name == "")) > 0){
  c6$Name[ind] <- paste0("m/z ",c6$m.z.meas.[ind])
}
c6[1,2] <- "hatching"
dup <- c6$rph[duplicated(c6$Name)]
c6 <- c6[!c6$rph == dup,]
corhextp_f <- corhextp_f[!rownames(corhextp_f) %in% dup, !colnames(corhextp_f) %in% dup]
row.names(corhextp_f) <- c6$Name
names(corhextp_f) <- c6$Name
colnames(corhextp_f) <- c6$Name

#draw plot
testRes = cor.mtest(corhextp_f, conf.level = 0.95)
corrplot(as.matrix(corhextp_f), 
         order = "hclust", 
         diag = F,
         addrect = 2, 
         method = "circle",
         type = "lower",
         number.cex = 0.8,
         cl.pos = 'b', 
         p.mat = testRes$p, 
         sig.level = c(0.001, 0.01, 0.05),
         insig = "label_sig",
         pch.cex = 1,
         tl.srt = 45,
         tl.col = "black",
         tl.cex = 0.8,
         col = brewer.pal(n = 10, name = 'RdYlGn'))


#NEGATIVE MODE------------------------------------------------------------------------------------------

#metabolite matrix should not be normalized with root weight for hatching
extract_neg_ft <- as.data.frame(extract_neg_ft)
extract_neg_ft$H01 <- xp_design_extracts$Hatching
corhextn <- cor(extract_neg_ft) %>% as.data.frame()
corhextn <- corhextn[order(-corhextn$H01),]
corhextn_f <- corhextn[c(1:11, (length(corhextn) - 9):(length(corhextn))),]
rnh <- as.vector(rownames(corhextn_f))
corhextn_f <- corhextn_f[, which(colnames(corhextn_f) %in% rnh)] %>% as.matrix()

# order the matrix
corhextn_f <- as.data.frame(corhextn_f[rnh, rnh])

#change names to correct names
rnh <- as.data.frame(rnh)
names(rnh) <- "rnh"
compounds_extract_neg1 <- compounds_extract_neg %>% rownames_to_column("rnh")
c7 <- left_join(rnh, compounds_extract_neg1[,c("rnh","Name","m.z.meas.")], by = "rnh")
c7$m.z.meas. <- substr(c7$m.z.meas., 0, 6)
while(length(ind <- which(c7$Name == "")) > 0){
  c7$Name[ind] <- paste0("m/z ",c7$m.z.meas.[ind])
}
c7[1,2] <- "hatching"
dup <- c7$rnh[duplicated(c7$Name)]
c7 <- c7[!c7$rnh == dup,]
corhextn_f <- corhextn_f[!rownames(corhextn_f) %in% dup, !colnames(corhextn_f) %in% dup]
row.names(corhextn_f) <- c7$Name
names(corhextn_f) <- c7$Name
colnames(corhextn_f) <- c7$Name

#draw plot
testRes = cor.mtest(corhextn_f, conf.level = 0.95)
corrplot(as.matrix(corhextn_f), 
         order = "hclust", 
         diag = F,
         addrect = 2, 
         method = "circle",
         type = "lower",
         number.cex = 0.8,
         cl.pos = 'b', 
         p.mat = testRes$p, 
         sig.level = c(0.001, 0.01, 0.05),
         insig = "label_sig",
         pch.cex = 1,
         tl.srt = 45,
         tl.col = "black",
         tl.cex = 0.8,
         col = brewer.pal(n = 10, name = 'RdYlGn'))
```