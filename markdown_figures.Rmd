---
title: "SolA barplot"
author: "Lieke Vlaar"
date: "20/10/2021"
output: html_document
---

# Necessary libraries

```{r libraries, show = FALSE, message = FALSE}
library(ggplot2)
library(tidyr)
library(dplyr)
library(tibble)
library(mdatools)
library(DESeq2)
library(vsn)
library(ggfortify)
library(RColorBrewer)
library(corrplot)
```

# Figure 1

```{r figure1}
sol <- read.csv("input/solA_conc_all.csv", header = TRUE, 
                  fileEncoding = "UTF-8-BOM")

sol2 <- sol %>% group_by(Sample, Company, selected) %>% summarize(meanconc =  mean(SolA_concentration_pmol.per.g.FW),
              stdevconc = sd(SolA_concentration_pmol.per.g.FW))


f1 <- ggplot(data = sol2, aes(x = reorder(Sample, -meanconc), y = meanconc, fill = selected)) +
  geom_bar(stat = "identity") +
  geom_errorbar(mapping=aes(x=Sample, ymin=meanconc - stdevconc, ymax=meanconc + stdevconc), width=0.5, size=0.5) +
  geom_point(data = sol, aes(x = Sample, y = SolA_concentration_pmol.per.g.FW)) +
  theme_light() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
        axis.title.x = element_blank()) +
  ylab("solA conc. pmol/g FW") +
  scale_fill_brewer(palette="Dark2")
f1
```

Make Figure B (correlation solA and hatching)

```{r, fig.width = 8, fig.height = 5}
xp_design <- read.csv("input/23gt_rootweightsolA.csv", header = TRUE, fileEncoding = "UTF-8-BOM")
xp_design_f <- xp_design[xp_design$conc.forhatching.nM != 0 & xp_design$Hatching != 0,] %>% na.omit()

#linear relationship
ggplot(data = xp_design, aes(x = conc.forhatching.nM, y = Hatching)) +
  geom_point() +
  stat_smooth(method="lm", 
                  formula=y~x,
                  se = F) +
  theme_light() +
  ylab("hatching (%)") +
  xlab("solA conc. (nM)") +
      stat_poly_eq(formula = y~x, 
                   aes(label = paste(..rr.label..)), 
                   parse = TRUE, size = 5,
                   label.x = 0.05,
                   label.y = 35)

#logarithmic relationship
ggplot(data = xp_design_f, aes(x = conc.forhatching.nM, y = Hatching)) +
  geom_point(size = 2,
                 aes(shape = Genotype.name)) +
      scale_shape_manual(values=c(0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24))+
  stat_smooth(method="lm", 
                  formula=y~log(x),
                  se = FALSE,
                  colour = "black") +
  theme_light() +
  ylab("hatching (%)") +
  xlab("solA conc. (nM)") +
  stat_fit_glance(method = 'lm',
                      method.args = list(formula = y~log(x)),
                      geom = 'text',
                      aes(label = paste("p-value = ", signif(..p.value.., digits = 4), sep = "")),
                      size = 5,
                      label.x = 5.6,
                      label.y = 38) +
  stat_poly_eq(formula = y~log(x), 
                   aes(label = paste(..rr.label..)), 
                   parse = TRUE, size = 5,
                   label.x = 0.04,
                   label.y = 0.91)

#polynomial relationship
ggplot(data = xp_design_f, aes(x = conc.forhatching.nM, y = Hatching)) +
  geom_point() +
  stat_smooth(method="lm", 
                  formula=y~poly(x, 2),
                  se = FALSE,
                  colour = "black") +
  theme_light() +
  ylab("hatching (%)") +
  xlab("solA conc. (nM)") +
  stat_fit_glance(method = 'lm',
                      method.args = list(formula = y~poly(x, 2)),
                      geom = 'text',
                      aes(label = paste("P-value = ", signif(..p.value.., digits = 4), sep = "")),
                      size = 5,
                      label.x = 5,
                      label.y = 38) +
  stat_poly_eq(formula = y~poly(x), 
                   aes(label = paste(..rr.label..)), 
                   parse = TRUE, size = 5,
                   label.x = 0.04,
                   label.y = 0.91)

```

# Figure 3

First we need to import,  trim and filter the data
```{r importfiltertrim}
#import
exudate_pos <- read.csv("input/211124_Metabo_Exu_pos.csv", header = TRUE, fileEncoding = "UTF-8-BOM")
exudate_neg <- read.csv("input/root_exudate_negM1.csv", header = TRUE, fileEncoding = "UTF-8-BOM")

#adapt exudate_pos to same structure as exudate_neg
fts <- names(exudate_pos)[3:length(names(exudate_pos))-1]
fts <- gsub("FT","",fts)
samples <- names(exudate_neg)[9:113]
exudate_pos <- exudate_pos[,-c(1,2)]
names(exudate_pos) <- fts
row.names(exudate_pos) <- samples
exudate_pos <- exudate_pos %>% t() %>% as.data.frame()

#remove QC samples: are not important in dataset <500 samples
exudate_neg <- exudate_neg[,1:113]

#get xp_design file
xp_design <- read.csv("input/23gt_rootweightsolA.csv", header = TRUE, fileEncoding = "UTF-8-BOM")
compounds_exudate_neg <- exudate_neg[,1:8]
compounds_exudate_pos <- read.csv("input/211124_Feature definition.csv", header = TRUE, fileEncoding = "UTF-8-BOM") %>% rownames_to_column("sample")
compounds_exudate_pos$sample <- gsub("FT","",compounds_exudate_pos$sample)
compounds_exudate_pos <- compounds_exudate_pos %>% column_to_rownames("sample")
exudate_neg <- exudate_neg[,9:113]

#use filtertrim function to filter and trim the two data tables

source("scripts/filtertrim.R")
exudate_neg_f <- filtertrim(x = exudate_neg)
exudate_pos_f <- filtertrim(x = exudate_pos)
```

Then we can correct for root weight, scale and centre
```{r Figure2}
#normalize for root weight
source("scripts/correctforrootweight.R")
exudate_neg_fr <- correctforrootweight(x = exudate_neg_f)
exudate_pos_fr <- correctforrootweight(x = exudate_pos_f)

#scale and centre
source("scripts/scalecentrevsn.R")
exudate_neg_frt <- scalecentrevsn(x = exudate_neg_fr)
exudate_pos_frt <- scalecentrevsn(x = exudate_pos_fr)

#check with plots
meanSdPlot(t(exudate_neg_f))
meanSdPlot(exudate_neg_fr)
meanSdPlot(exudate_neg_frt)

meanSdPlot(t(exudate_pos_f))
meanSdPlot(exudate_pos_fr)
meanSdPlot(exudate_pos_frt)
```

Vsn transformation is very important for the heteroscedasticity.
Now plot a PCA plot

```{r, fig.height = 6, fig.width = 8}
source("scripts/plotpca.R")
plotpca(x = exudate_neg_frt)
plotpca(x = exudate_pos_frt)
plotpca3(x = exudate_neg_frt, xaxis = "(68.28%)", yaxis = "(4.83%)")
plotpca3(x = exudate_pos_frt, xaxis = "(41.41%)", yaxis = "(13.88%)")
```


## Correlation plots

Correlation plot (Figure 3) (corrected for root weight)

```{r corrplot, fig.height = 8, fig.width = 8}
#make compounds dfs for pos and neg
c_pos <- compounds_exudate_pos[, c(1,4)]
c_pos$Name <- rep("",nrow(c_pos))
names(c_pos) <- c("mz","Rt","Name")
c_pos$Rt <- c_pos$Rt / 60
c_neg <- compounds_exudate_neg[, c(1,2,6)]
names(c_neg) <- c("Rt","mz","Name")

#get corr dfs
source("scripts/ordermatrixforcorplot.R")
c_exup_sol <- ordermatrixforcorplot(x = exudate_pos_fr, interest = "solA_UHPLC", compounds = c_pos)
c_exun_sol <- ordermatrixforcorplot(x = exudate_neg_fr, interest = "solA_UHPLC", compounds = c_neg)
```

Getting testRes results takes very long, therefore they were run once and saved in output, but they can be newly obtained from this snippet:
```{r, eval=F}
c0_exup_sol <- ordermatrixforcorplot2(x = exudate_pos_fr, interest = "solA_UHPLC", compounds = c_pos)
testRes_c_exup_sol <- cor.mtest(as.data.frame(c0_exup_sol), conf.level = 0.95)
testRes_c_exup_sol <- as.data.frame(testRes_c_exup_sol$p)
c0_exun_sol <- ordermatrixforcorplot2(x = exudate_neg_fr, interest = "solA_UHPLC", compounds = c_neg)
testRes_c_exun_sol <- cor.mtest(as.data.frame(c0_exun_sol), conf.level = 0.95)
testRes_c_exun_sol <- as.data.frame(testRes_c_exun_sol$p)
```

Import the testRes dfs, then draw the correlation plot:
```{r, fig.height = 5.5, fig.width = 5.5}
#import testRes dfs
testRes_c_exup_sol <- read.csv("output/testRes_c_exup_sol.csv", header = TRUE, fileEncoding = "UTF-8-BOM") %>% column_to_rownames("X")
names(testRes_c_exup_sol) <- row.names(testRes_c_exup_sol)
testRes_c_exun_sol <- read.csv("output/testRes_c_exun_sol.csv", header = TRUE, fileEncoding = "UTF-8-BOM") %>% column_to_rownames("X")
names(testRes_c_exun_sol) <- row.names(testRes_c_exun_sol)
#get the subset necessary for the plot:
source("scripts/ordermatrixforcorplot.R")
testRes_c_exup_sol_subset <- get_testRes(x = exudate_pos_fr, interest = "solA_UHPLC", compounds = c_pos, t = testRes_c_exup_sol)
testRes_c_exun_sol_subset <- get_testRes(x = exudate_neg_fr, interest = "solA_UHPLC", compounds = c_neg, t = testRes_c_exun_sol)

#plot corplot
source("scripts/plotcor.R")
corplot_exup_sol <- plotcor(x = c_exup_sol, t = testRes_c_exup_sol_subset)
corplot_exun_sol <- plotcor(x = c_exun_sol, t = testRes_c_exun_sol_subset)
```



Correlation of hatching with unknown metabolites (not corrected for root weight)

```{r corr_hatching_vs_metabolites, fig.height = 8, fig.width = 8}
#get corr dfs
source("scripts/ordermatrixforcorplot.R")
c_exup_hatching <- ordermatrixforcorplot(x = t(exudate_pos_f), interest = "hatching", compounds = c_pos)
c_exun_hatching <- ordermatrixforcorplot(x = t(exudate_neg_f), interest = "hatching", compounds = c_neg)
```

Getting testRes results takes very long, therefore they were run once and saved in output, but they can be newly obtained from this snippet:
```{r, eval=F}
c0_exup_hatching <- ordermatrixforcorplot2(x = t(exudate_pos_f), interest = "hatching", compounds = c_pos)
testRes_c_exup_hatching <- cor.mtest(as.data.frame(c0_exup_hatching), conf.level = 0.95)
testRes_c_exup_hatching <- as.data.frame(testRes_c_exup_hatching$p)
c0_exun_hatching <- ordermatrixforcorplot2(x = t(exudate_neg_f), interest = "hatching", compounds = c_neg)
testRes_c_exun_hatching <- cor.mtest(as.data.frame(c0_exun_hatching), conf.level = 0.95)
testRes_c_exun_hatching <- as.data.frame(testRes_c_exun_hatching$p)
```

Import the testRes dfs, then draw the correlation plot:
```{r, fig.height = 5.5, fig.width = 5.5}
#import testRes dfs
testRes_c_exup_hatching <- read.csv("output/testRes_c_exup_hatching.csv", header = TRUE, fileEncoding = "UTF-8-BOM") %>% column_to_rownames("X")
names(testRes_c_exup_hatching) <- row.names(testRes_c_exup_hatching)
testRes_c_exun_hatching <- read.csv("output/testRes_c_exun_hatching.csv", header = TRUE, fileEncoding = "UTF-8-BOM") %>% column_to_rownames("X")
names(testRes_c_exun_hatching) <- row.names(testRes_c_exun_hatching)
#get the subset necessary for the plot:
source("scripts/ordermatrixforcorplot.R")
testRes_c_exup_hatching_subset <- get_testRes(x = t(exudate_pos_f), interest = "hatching", compounds = c_pos, t = testRes_c_exup_hatching)
testRes_c_exun_hatching_subset <- get_testRes(x = t(exudate_neg_f), interest = "hatching", compounds = c_neg, t = testRes_c_exun_hatching)

#plot corplot
source("scripts/plotcor.R")
corplot_exup_hatching <- plotcor(x = c_exup_hatching, t = testRes_c_exup_hatching_subset)
corplot_exun_hatching <- plotcor(x = c_exun_hatching, t = testRes_c_exun_hatching_subset)
```

Make a list of all the compounds that correlate with solA concentration and hatching

```{r}
d1 <- data.frame(rownames(c_exun_hatching)[2:11], rep("exudate_neg_hatching", 10))
d2 <- data.frame(rownames(c_exup_hatching)[2:11], rep("exudate_pos_hatching", 10))
d3 <- data.frame(rownames(c_exun_sol)[2:11], rep("exudate_neg_solA",10))
d4 <- data.frame(rownames(c_exup_sol)[2:11], rep("exudate_pos_solA",10))
names(d1) <- c("c","s")
names(d2) <- c("c","s")
names(d3) <- c("c","s")
names(d4) <- c("c","s")
d <- rbind(d1,d2,d3,d4)
write.csv(d, "output/correlatingcompounds.csv")
```

## Make plot of only compound 525.18 (-)

```{r}
exudate1997 <- exudate_neg_fr %>% t() %>% as.data.frame()
exudate1997 <- exudate1997[row.names(exudate1997) == "1997",] %>% t() %>% as.data.frame()
names(exudate1997) <- "counts"
exudate1997$genotype <- xp_design$Genotype.name[1:100]
exudate1997sum <- exudate1997 %>% group_by(genotype) %>% summarize(meancounts = mean(counts))
ggplot(data = exudate1997sum, aes(x = genotype, y = meancounts)) +
  geom_bar(stat = "identity", fill = "grey", colour = "black") +
  geom_point(data = exudate1997, aes(x = genotype, y = counts)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylab("counts") + xlab("")
  
```


# Root extracts (Figure 4)

First import and trim
```{r import transform}
extract_pos <- read.csv("input/root_extract_posM1.csv", header = TRUE, fileEncoding = "UTF-8-BOM")
extract_neg <- read.csv("input/root_extract_negM1.csv", header = TRUE, fileEncoding = "UTF-8-BOM")
extract_pos <- extract_pos[,1:106]
extract_neg <- extract_neg[,2:107]

compounds_extract_pos <- extract_pos[,1:8]
compounds_extract_neg <- extract_neg[,1:8]
extract_pos <- extract_pos[,9:ncol(extract_pos)]
extract_neg <- extract_neg[,9:ncol(extract_neg)]

#filter compounds with very low total counts (less than 100,000 in total)
source("scripts/filtertrim.R")
extract_pos_f <- filtertrim(x = extract_pos)
extract_neg_f <- filtertrim(x = extract_neg)
```


Root extracts are made from 100 mg root, so do not need to be corrected for root weight. 
For PCA, they do need to be scaled and centred.
```{r Figure2}
#scale and centre
source("scripts/scalecentrevsn.R")
extract_neg_ft <- scalecentrevsn(x = t(extract_neg_f))
extract_pos_ft <- scalecentrevsn(x = t(extract_pos_f))

#check with plots
meanSdPlot(t(extract_neg_f))
meanSdPlot(extract_neg_ft)

meanSdPlot(t(extract_pos_f))
meanSdPlot(extract_pos_ft)
```

Plot PCA
```{r, fig.height = 6, fig.width = 8}
source("scripts/plotpca.R")
plotpca(x = extract_neg_ft) + scale_size(guide = "none")
plotpca(x = extract_pos_ft) + scale_size(guide = "none")
```

## correlation plots root extracts

```{r corrplot}
#make compounds dfs for pos and neg
c_pos_extr <- compounds_extract_pos[, c(1,2,6)]
names(c_pos_extr) <- c("Rt","mz","Name")
c_neg_extr <- compounds_extract_neg[, c(1,2,6)]
names(c_neg_extr) <- c("Rt","mz","Name")

#get corr dfs
source("scripts/ordermatrixforcorplot.R")
c_extp_sol <- ordermatrixforcorplot(x = t(extract_pos_f), interest = "solA_UHPLC", compounds = c_pos_extr)
c_extn_sol <- ordermatrixforcorplot(x = t(extract_neg_f), interest = "solA_UHPLC", compounds = c_neg_extr)
```

Getting testRes results takes very long, therefore they were run once and saved in output, but they can be newly obtained from this snippet:
```{r, eval=F}
c0_extp_sol <- ordermatrixforcorplot2(x = t(extract_pos_f), interest = "solA_UHPLC", compounds = c_pos)
testRes_c_extp_sol <- cor.mtest(as.data.frame(c0_extp_sol), conf.level = 0.95)
testRes_c_extp_sol <- as.data.frame(testRes_c_extp_sol$p)
c0_extn_sol <- ordermatrixforcorplot2(x = t(extract_neg_f), interest = "solA_UHPLC", compounds = c_neg)
testRes_c_extn_sol <- cor.mtest(as.data.frame(c0_extn_sol), conf.level = 0.95)
testRes_c_extn_sol <- as.data.frame(testRes_c_extn_sol$p)
```

Import the testRes dfs, then draw the correlation plot:
```{r, fig.height = 5.5, fig.width = 5.5}
#import testRes dfs
testRes_c_extp_sol <- read.csv("output/testRes_c_extp_sol.csv", header = TRUE, fileEncoding = "UTF-8-BOM") %>% column_to_rownames("X")
names(testRes_c_extp_sol) <- row.names(testRes_c_extp_sol)
testRes_c_extn_sol <- read.csv("output/testRes_c_extn_sol.csv", header = TRUE, fileEncoding = "UTF-8-BOM") %>% column_to_rownames("X")
names(testRes_c_extn_sol) <- row.names(testRes_c_extn_sol)
#get the subset necessary for the plot:
source("scripts/ordermatrixforcorplot.R")
testRes_c_extp_sol_subset <- get_testRes(x = t(extract_pos_f), interest = "solA_UHPLC", compounds = c_pos_extr, t = testRes_c_extp_sol)
testRes_c_extn_sol_subset <- get_testRes(x = t(extract_neg_f), interest = "solA_UHPLC", compounds = c_neg_extr, t = testRes_c_extn_sol)

#plot corplot
source("scripts/plotcor.R")
corplot_extp_sol <- plotcor(x = c_extp_sol, t = testRes_c_extp_sol_subset)
corplot_extn_sol <- plotcor(x = c_extn_sol, t = testRes_c_extn_sol_subset)
```

```{r corr_hatching_vs_metabolites, fig.height = 8, fig.width = 8}
#get corr dfs
source("scripts/ordermatrixforcorplot.R")
c_extp_hatching <- ordermatrixforcorplot(x = t(extract_pos_f), interest = "hatching", compounds = c_pos_extr)
c_extn_hatching <- ordermatrixforcorplot(x = t(extract_neg_f), interest = "hatching", compounds = c_neg_extr)
```

Getting testRes results takes very long, therefore they were run once and saved in output, but they can be newly obtained from this snippet:
```{r, eval=F}
c0_extp_hatching <- ordermatrixforcorplot2(x = t(extract_pos_f), interest = "hatching", compounds = c_pos)
testRes_c_extp_hatching <- cor.mtest(as.data.frame(c0_extp_hatching), conf.level = 0.95)
testRes_c_extp_hatching <- as.data.frame(testRes_c_extp_hatching$p)
c0_extn_hatching <- ordermatrixforcorplot2(x = t(extract_neg_f), interest = "hatching", compounds = c_neg)
testRes_c_extn_hatching <- cor.mtest(as.data.frame(c0_extn_hatching), conf.level = 0.95)
testRes_c_extn_hatching <- testRes_c_extn_hatching$p
```

Import the testRes dfs, then draw the correlation plot:
```{r, fig.height = 5.5, fig.width = 5.5}
#import testRes dfs
testRes_c_extp_hatching <- read.csv("output/testRes_c_extp_hatching.csv", header = TRUE, fileEncoding = "UTF-8-BOM")%>% column_to_rownames("X")
names(testRes_c_extp_hatching) <- row.names(testRes_c_extp_hatching)
testRes_c_extn_hatching <- read.csv("output/testRes_c_extn_hatching.csv", header = TRUE, fileEncoding = "UTF-8-BOM") %>%column_to_rownames("X")
names(testRes_c_extn_hatching) <- row.names(testRes_c_extn_hatching)
#get the subset necessary for the plot:
source("scripts/ordermatrixforcorplot.R")
testRes_c_extp_hatching_subset <- get_testRes(x = t(extract_pos_f), interest = "hatching", compounds = c_pos_extr, t = testRes_c_extp_hatching)
testRes_c_extn_hatching_subset <- get_testRes(x = t(extract_neg_f), interest = "hatching", compounds = c_neg_extr, t = testRes_c_extn_hatching)

#plot corplot
source("scripts/plotcor.R")
corplot_extp_hatching <- plotcor(x = c_extp_hatching, t = testRes_c_extp_hatching_subset)
corplot_extn_hatching <- plotcor(x = c_extn_hatching, t = testRes_c_extn_hatching_subset)
```