---
title: "SolA barplot"
author: "Lieke Vlaar"
date: "20/10/2021"
output: html_document
---

# Necessary libraries

```{r libraries, show = FALSE, message = FALSE}
library(ggplot2)
library(tidyr)
library(dplyr)
library(tibble)
library(mdatools)
library(DESeq2)
library(vsn)
library(ggfortify)
library(RColorBrewer)
library(corrplot)
```

# Figure 1

```{r figure1}
sol <- read.csv("input/solA_conc_all.csv", header = TRUE, 
                  fileEncoding = "UTF-8-BOM")

sol2 <- sol %>% group_by(Sample, Company, selected) %>% summarize(meanconc =  mean(SolA_concentration_pmol.per.g.FW),
              stdevconc = sd(SolA_concentration_pmol.per.g.FW))


f1 <- ggplot(data = sol2, aes(x = reorder(Sample, -meanconc), y = meanconc, fill = selected)) +
  geom_bar(stat = "identity") +
  geom_errorbar(mapping=aes(x=Sample, ymin=meanconc - stdevconc, ymax=meanconc + stdevconc), width=0.5, size=0.5) +
  geom_point(data = sol, aes(x = Sample, y = SolA_concentration_pmol.per.g.FW)) +
  theme_light() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
        axis.title.x = element_blank()) +
  ylab("solA conc. pmol/g FW") +
  scale_fill_brewer(palette="Dark2")
f1
```


# Figure 2

First we need to import,  trim and filter the data
```{r importfiltertrim}
#import
exudate_pos <- read.csv("input/211124_Metabo_Exu_pos.csv", header = TRUE, fileEncoding = "UTF-8-BOM")
exudate_neg <- read.csv("input/root_exudate_negM1.csv", header = TRUE, fileEncoding = "UTF-8-BOM")

#adapt exudate_pos to same structure as exudate_neg
fts <- names(exudate_pos)[3:length(names(exudate_pos))-1]
fts <- gsub("FT","",fts)
samples <- names(exudate_neg)[9:113]
exudate_pos <- exudate_pos[,-c(1,2)]
names(exudate_pos) <- fts
row.names(exudate_pos) <- samples
exudate_pos <- exudate_pos %>% t() %>% as.data.frame()

#remove QC samples: are not important in dataset <500 samples
exudate_neg <- exudate_neg[,1:113]

#get xp_design file
xp_design <- read.csv("input/23gt_rootweightsolA.csv", header = TRUE, fileEncoding = "UTF-8-BOM")
compounds_exudate_neg <- exudate_neg[,1:8]
compounds_exudate_pos <- read.csv("input/211124_Feature definition.csv", header = TRUE, fileEncoding = "UTF-8-BOM") %>% rownames_to_column("sample")
compounds_exudate_pos$sample <- gsub("FT","",compounds_exudate_pos$sample)
compounds_exudate_pos <- compounds_exudate_pos %>% column_to_rownames("sample")
exudate_neg <- exudate_neg[,9:113]

#use filtertrim function to filter and trim the two data tables

source("scripts/filtertrim.R")
exudate_neg_f <- filtertrim(x = exudate_neg)
exudate_pos_f <- filtertrim(x = exudate_pos)
```

Then we can correct for root weight, scale and centre
```{r Figure2}
#normalize for root weight
source("scripts/correctforrootweight.R")
exudate_neg_fr <- correctforrootweight(x = exudate_neg_f)
exudate_pos_fr <- correctforrootweight(x = exudate_pos_f)

#scale and centre
source("scripts/scalecentrevsn.R")
exudate_neg_frt <- scalecentrevsn(x = exudate_neg_fr)
exudate_pos_frt <- scalecentrevsn(x = exudate_pos_fr)

#check with plots
meanSdPlot(t(exudate_neg_f))
meanSdPlot(exudate_neg_fr)
meanSdPlot(exudate_neg_frt)

meanSdPlot(t(exudate_pos_f))
meanSdPlot(exudate_pos_fr)
meanSdPlot(exudate_pos_frt)
```

Vsn transformation is very important for the heteroscedasticity.
Now plot a PCA plot

```{r, fig.height = 6, fig.width = 8}
#remove X in names
exudate_neg_frt <- as.data.frame(exudate_neg_frt) %>% rownames_to_column("ID") 
exudate_neg_frt$ID <- gsub("X","",exudate_neg_frt$ID)
exudate_neg_frt <- exudate_neg_frt %>% column_to_rownames("ID")
exudate_pos_frt <- as.data.frame(exudate_pos_frt) %>% rownames_to_column("ID") 
exudate_pos_frt$ID <- gsub("X","",exudate_pos_frt$ID)
exudate_pos_frt <- exudate_pos_frt %>% column_to_rownames("ID")

source("scripts/plotpca.R")
plotpca(x = exudate_neg_frt)
plotpca(x = exudate_pos_frt)
```


## Correlation plots

Correlation plot (Figure 2) (corrected for root weight)

```{r corrplot, fig.height = 8, fig.width = 8}
#make compounds dfs for pos and neg
c_pos <- compounds_exudate_pos[, c(1,4)]
c_pos$Name <- rep("",nrow(c_pos))
names(c_pos) <- c("mz","Rt","Name")
c_pos$Rt <- c_pos$Rt / 60
c_neg <- compounds_exudate_neg[, c(1,2,6)]
names(c_neg) <- c("Rt","mz","Name")

#get corr dfs
source("scripts/ordermatrixforcorplot.R")
c_exup_sol <- ordermatrixforcorplot(x = exudate_pos_fr, interest = "solA", compounds = c_pos)
c_exun_sol <- ordermatrixforcorplot(x = exudate_neg_fr, interest = "solA", compounds = c_neg)

#plot corplot
source("scripts/plotcor.R")
testRes = cor.mtest(c_exup_sol, conf.level = 0.95)
corplot_exup_sol <- plotcor(x = c_exup_sol)
testRes = cor.mtest(c_exun_sol, conf.level = 0.95)
corplot_exun_sol <- plotcor(x = c_exun_sol)
```




Correlation of hatching with unknown metabolites (not corrected for root weight)

```{r corr_hatching_vs_metabolites, fig.height = 8, fig.width = 8}
#get corr dfs
source("scripts/ordermatrixforcorplot.R")
c_exup_hatching <- ordermatrixforcorplot(x = t(exudate_pos_f), interest = "hatching", compounds = c_pos)
c_exun_hatching <- ordermatrixforcorplot(x = t(exudate_neg_f), interest = "hatching", compounds = c_neg)

#plot corplot
source("scripts/plotcor.R")
testRes = cor.mtest(c_exup_hatching, conf.level = 0.95)
corplot_exup_hatching <- plotcor(x = c_exup_hatching)
testRes = cor.mtest(c_exun_hatching, conf.level = 0.95)
corplot_exun_hatching <- plotcor(x = c_exun_hatching)
```

Make a list of all the compounds that correlate with solA concentration and hatching

```{r}
d1 <- data.frame(rownames(c_exun_hatching)[2:11], rep("exudate_neg_hatching", 10))
d2 <- data.frame(rownames(c_exup_hatching)[2:11], rep("exudate_pos_hatching", 10))
d3 <- data.frame(rownames(c_exun_sol)[2:11], rep("exudate_neg_solA",10))
d4 <- data.frame(rownames(c_exup_sol)[2:11], rep("exudate_pos_solA",10))
names(d1) <- c("c","s")
names(d2) <- c("c","s")
names(d3) <- c("c","s")
names(d4) <- c("c","s")
d <- rbind(d1,d2,d3,d4)
write.csv(d, "output/correlatingcompounds.csv")
```




# Root extracts (Figure 3)

First import and trim
```{r import transform}
extract_pos <- read.csv("input/root_extract_posM1.csv", header = TRUE, fileEncoding = "UTF-8-BOM")
extract_neg <- read.csv("input/root_extract_negM1.csv", header = TRUE, fileEncoding = "UTF-8-BOM")
extract_pos <- extract_pos[,1:106]
extract_neg <- extract_neg[,2:107]

compounds_extract_pos <- extract_pos[,1:8]
compounds_extract_neg <- extract_neg[,1:8]
extract_pos <- extract_pos[,9:ncol(extract_pos)]
extract_neg <- extract_neg[,9:ncol(extract_neg)]

#filter compounds with very low total counts (less than 100,000 in total)
extract_pos_f <- extract_pos[rowSums(extract_pos) >50000, ]
extract_neg_f <- extract_neg[rowSums(extract_neg) >50000, ]
```


Then correct for root weight, scale and centre:
```{r Figure2}
#extract only useful rows from xp_design
samples_extracts <- colnames(extract_pos)
samples_extracts <- gsub("X","",samples_extracts)
xp_design_extracts <- xp_design[xp_design$Number %in% samples_extracts,]
rootw_extracts <- xp_design$root.fresh.weight..g.

#normalize for root weight
extract_pos_ft <- t(extract_pos_f)
extract_pos_ftr <- t(t(extract_pos_ft)) / rootw_extracts
extract_neg_ft <- t(extract_neg_f)
extract_neg_ftr <- t(t(extract_neg_ft)) / rootw_extracts

#scale and centre
extract_pos_ftrcs <- prep.autoscale(extract_pos_ftr, center = TRUE, scale = TRUE)
extract_pos_ftrc <- prep.autoscale(extract_pos_ftr, center = TRUE, scale = F)
extract_pos_ftrs <- prep.autoscale(extract_pos_ftr, center = F, scale = T)
boxplot(extract_pos_ftr, main = "raw")
boxplot(extract_pos_ftrc, main = "only centered")
boxplot(extract_pos_ftrs, main = "only scaled")
boxplot(extract_pos_ftrcs, main = "centered and scaled")

extract_pos_ftrcsv <- justvsn(extract_pos_ftrcs)
extract_pos_ftrsv <- justvsn(extract_pos_ftrs)
meanSdPlot(extract_pos_ftrcs)
meanSdPlot(extract_pos_ftrcsv)
meanSdPlot(extract_pos_ftrs)
meanSdPlot(extract_pos_ftrsv)

#check heteroscedasticity (though this is probably the same as the meanSdPlot of above)
extract_pos_ftrcs <- as.data.frame(extract_pos_ftrcs)
extract_pos_ftrcs$mean <- rowMeans(as.matrix(extract_pos_ftrcs))
extract_pos_ftrcs$sds <- rowSds(as.matrix(extract_pos_ftrcs))
ggplot(data = extract_pos_ftrcs, aes(x = mean, y = sds)) +
  geom_point()
extract_pos_ftrcs <- as.matrix(extract_pos_ftrcs)
extract_pos_ftrcsv2 <- as.data.frame(extract_pos_ftrcsv)
extract_pos_ftrcsv2$mean <- rowMeans(extract_pos_ftrcsv2)
extract_pos_ftrcsv2$sds <- rowSds(as.matrix(extract_pos_ftrcsv2))
ggplot(data = extract_pos_ftrcsv2, aes(x = mean, y = sds)) +
  geom_point()
```

Plot PCA
```{r, fig.height = 6, fig.width = 8}
#remove X in names
extract_pos_ftrcsv <- as.data.frame(extract_pos_ftrcsv) %>% rownames_to_column("ID") 
extract_pos_ftrcsv$ID <- gsub("X","",extract_pos_ftrcsv$ID)
extract_pos_ftrcsv <- extract_pos_ftrcsv %>% column_to_rownames("ID")

#plot pca centered and scaled
pca_res <- prcomp(extract_pos_ftrcsv, scale. = F)
extract_pos_ftrcsv2 <- as.data.frame(cbind(extract_pos_ftrcsv, xp_design_extracts$Genotype.name))
names(extract_pos_ftrcsv2)[length(names(extract_pos_ftrcsv2))]  <- "Genotype.name"
extract_pos_ftrcsv2$Genotype.name <- as.factor(extract_pos_ftrcsv2$Genotype.name)
autoplot(pca_res, data = extract_pos_ftrcsv2, colour = 'Genotype.name', label = TRUE, shape = F, label.size = 3) + theme_minimal() + scale_color_manual(values = c25) + scale_size(guide = "none")
```

Also do transformations and pca plot for negative mode

```{r Figure3, fig.height = 6, fig.width = 8}
#scale and centre
extract_neg_ftrcs <- prep.autoscale(extract_neg_ftr, center = TRUE, scale = TRUE)
boxplot(extract_neg_ftrcs, main = "centered and scaled")

extract_neg_ftrcsv <- justvsn(extract_neg_ftrcs)
meanSdPlot(extract_neg_ftrcs)
meanSdPlot(extract_neg_ftrcsv)

#check heteroscedasticity (though this is probably the same as the meanSdPlot of above)
extract_neg_ftrcs <- as.data.frame(extract_neg_ftrcs)
extract_neg_ftrcs$mean <- rowMeans(as.matrix(extract_neg_ftrcs))
extract_neg_ftrcs$sds <- rowSds(as.matrix(extract_neg_ftrcs))
ggplot(data = extract_neg_ftrcs, aes(x = mean, y = sds)) +
  geom_point()
extract_neg_ftrcs <- as.matrix(extract_neg_ftrcs)
extract_neg_ftrcsv2 <- as.data.frame(extract_neg_ftrcsv)
extract_neg_ftrcsv2$mean <- rowMeans(extract_neg_ftrcsv2)
extract_neg_ftrcsv2$sds <- rowSds(as.matrix(extract_neg_ftrcsv2))
ggplot(data = extract_neg_ftrcsv2, aes(x = mean, y = sds)) +
  geom_point()

#remove X in names
extract_neg_ftrcsv <- as.data.frame(extract_neg_ftrcsv) %>% rownames_to_column("ID") 
extract_neg_ftrcsv$ID <- gsub("X","",extract_neg_ftrcsv$ID)
extract_neg_ftrcsv <- extract_neg_ftrcsv %>% column_to_rownames("ID")

#plot pca centered and scaled
pca_res <- prcomp(extract_neg_ftrcsv, scale. = F)
extract_neg_ftrcsv2 <- as.data.frame(cbind(extract_neg_ftrcsv, xp_design_extracts$Genotype.name))
names(extract_neg_ftrcsv2)[length(names(extract_neg_ftrcsv2))]  <- "Genotype.name"
extract_neg_ftrcsv2$Genotype.name <- as.factor(extract_neg_ftrcsv2$Genotype.name)
autoplot(pca_res, data = extract_neg_ftrcsv2, colour = 'Genotype.name', label = TRUE, shape = F, label.size = 3) + theme_minimal() + scale_color_manual(values = c25) + scale_size(guide = "none")
```

## correlation plots

```{r corrplot, fig.height = 8, fig.width = 8}
#POSITIVE MODE-------------------------------------------------------------------------------------------
forcor4 <- as.data.frame(extract_pos_ftr)
forcor4$solA <- xp_design_extracts$Concentration.per.g.FW
corextp <- cor(forcor4)
corextp <- as.data.frame(corextp)
corextp <- corextp[order(-corextp$solA),]
corextp_f <- corextp[c(1:11, (length(corextp) - 9):(length(corextp))),]
rp <- row.names(corextp_f)
corextp_f <- corextp_f[, which(names(corextp_f) %in% rp)] %>% as.matrix()

#order the matrices
corextp_f <- as.data.frame(corextp_f[rp, rp])

#change names to compoundnames
rp <- as.data.frame(rp)
names(rp) <- "rp"
compounds_extract_pos1 <- compounds_extract_pos %>% rownames_to_column("rp")
c4 <- left_join(rp, compounds_extract_pos1[,c("rp","Name","m.z.meas.")], by = "rp")
c4$m.z.meas. <- substr(c4$m.z.meas., 0, 6)

while(length(ind <- which(c4$Name == "")) > 0){
  c4$Name[ind] <- paste0("m/z ",c4$m.z.meas.[ind])
}
c4$Name[c4$rp == "solA"] <- "solA"
row.names(corextp_f) <- c4$Name
corextp_f <- t(corextp_f)
row.names(corextp_f) <- c4$Name

#plot again
testRes = cor.mtest(corextp_f, conf.level = 0.95)
corrplot(corextp_f, 
         order = "hclust", 
         diag = F,
         addrect = 2, 
         method = "circle",
         type = "lower",
         number.cex = 0.8,
         cl.pos = 'b', 
         p.mat = testRes$p, 
         sig.level = c(0.001, 0.01, 0.05),
         insig = "label_sig",
         pch.cex = 1,
         tl.srt = 45,
         tl.col = "black",
         tl.cex = 0.8,
         col = brewer.pal(n = 10, name = 'RdYlGn'))

#NEGATIVE MODE-----------------------------------------------------------------------------------------
forcor5 <- as.data.frame(extract_neg_ftr)
forcor5$solA <- xp_design_extracts$Concentration.per.g.FW
corextn <- cor(forcor5)
corextn <- as.data.frame(corextn)
corextn <- corextn[order(-corextn$solA),]
corextn_f <- corextn[c(1:11, (length(corextn) - 9):(length(corextn))),]
rn <- row.names(corextn_f)
corextn_f <- corextn_f[, which(names(corextn_f) %in% rn)] %>% as.matrix()

#order the matrices
corextn_f <- as.data.frame(corextn_f[rn, rn])

#change names to compoundnames
rn <- as.data.frame(rn)
names(rn) <- "rn"
compounds_extract_neg1 <- compounds_extract_neg %>% rownames_to_column("rn")
c5 <- left_join(rn, compounds_extract_neg1[,c("rn","Name","m.z.meas.")], by = "rn")
c5$m.z.meas. <- substr(c5$m.z.meas., 0, 6)

while(length(ind <- which(c5$Name == "")) > 0){
  c5$Name[ind] <- paste0("m/z ",c5$m.z.meas.[ind])
}
c5$Name[c5$rn == "solA"] <- "solA"
dup <- c5$rn[duplicated(c5$Name)]
c5 <- c5[!c5$rn == dup,]
corextn_f <- corextn_f[!rownames(corextn_f) %in% dup, !colnames(corextn_f) %in% dup]
row.names(corextn_f) <- c5$Name
corextn_f <- t(corextn_f)
row.names(corextn_f) <- c5$Name

#plot again
testRes = cor.mtest(corextn_f, conf.level = 0.95)
corrplot(as.matrix(corextn_f), 
         order = "hclust", 
         diag = F,
         addrect = 2, 
         method = "circle",
         type = "lower",
         number.cex = 0.8,
         cl.pos = 'b', 
         p.mat = testRes$p, 
         sig.level = c(0.001, 0.01, 0.05),
         insig = "label_sig",
         pch.cex = 1,
         tl.srt = 45,
         tl.col = "black",
         tl.cex = 0.8,
         col = brewer.pal(n = 10, name = 'RdYlGn'))
```

```{r corr_hatching_vs_metabolites, fig.height = 8, fig.width = 8}
#POSITIVE MODE-------------------------------------------------------------------------------------------

#metabolite matrix should NOT be normalized with root weight for hatching
extract_pos_ft <- as.data.frame(extract_pos_ft)
extract_pos_ft$H01 <- xp_design_extracts$Hatching
corhextp <- cor(extract_pos_ft) %>% as.data.frame()
corhextp <- corhextp[order(-corhextp$H01),]
corhextp_f <- corhextp[c(1:11, (length(corhextp) - 9):(length(corhextp))),]
rph <- row.names(corhextp_f)
corhextp_f <- corhextp_f[, which(names(corhextp_f) %in% rph)] %>% as.matrix()

# order the matrix
corhextp_f <- as.data.frame(corhextp_f[rph, rph])

#change names to correct names
rph <- as.data.frame(rph)
names(rph) <- "rph"
compounds_extract_pos1 <- compounds_extract_pos %>% rownames_to_column("rph")
c6 <- left_join(rph, compounds_extract_pos1[,c("rph","Name", "m.z.meas.")], by = "rph")
c6$m.z.meas. <- substr(c6$m.z.meas., 0, 6)
while(length(ind <- which(c6$Name == "")) > 0){
  c6$Name[ind] <- paste0("m/z ",c6$m.z.meas.[ind])
}
c6[1,2] <- "hatching"
dup <- c6$rph[duplicated(c6$Name)]
c6 <- c6[!c6$rph == dup,]
corhextp_f <- corhextp_f[!rownames(corhextp_f) %in% dup, !colnames(corhextp_f) %in% dup]
row.names(corhextp_f) <- c6$Name
names(corhextp_f) <- c6$Name
colnames(corhextp_f) <- c6$Name

#draw plot
testRes = cor.mtest(corhextp_f, conf.level = 0.95)
corrplot(as.matrix(corhextp_f), 
         order = "hclust", 
         diag = F,
         addrect = 2, 
         method = "circle",
         type = "lower",
         number.cex = 0.8,
         cl.pos = 'b', 
         p.mat = testRes$p, 
         sig.level = c(0.001, 0.01, 0.05),
         insig = "label_sig",
         pch.cex = 1,
         tl.srt = 45,
         tl.col = "black",
         tl.cex = 0.8,
         col = brewer.pal(n = 10, name = 'RdYlGn'))


#NEGATIVE MODE------------------------------------------------------------------------------------------

#metabolite matrix should not be normalized with root weight for hatching
extract_neg_ft <- as.data.frame(extract_neg_ft)
extract_neg_ft$H01 <- xp_design_extracts$Hatching
corhextn <- cor(extract_neg_ft) %>% as.data.frame()
corhextn <- corhextn[order(-corhextn$H01),]
corhextn_f <- corhextn[c(1:11, (length(corhextn) - 9):(length(corhextn))),]
rnh <- as.vector(rownames(corhextn_f))
corhextn_f <- corhextn_f[, which(colnames(corhextn_f) %in% rnh)] %>% as.matrix()

# order the matrix
corhextn_f <- as.data.frame(corhextn_f[rnh, rnh])

#change names to correct names
rnh <- as.data.frame(rnh)
names(rnh) <- "rnh"
compounds_extract_neg1 <- compounds_extract_neg %>% rownames_to_column("rnh")
c7 <- left_join(rnh, compounds_extract_neg1[,c("rnh","Name","m.z.meas.")], by = "rnh")
c7$m.z.meas. <- substr(c7$m.z.meas., 0, 6)
while(length(ind <- which(c7$Name == "")) > 0){
  c7$Name[ind] <- paste0("m/z ",c7$m.z.meas.[ind])
}
c7[1,2] <- "hatching"
dup <- c7$rnh[duplicated(c7$Name)]
c7 <- c7[!c7$rnh == dup,]
corhextn_f <- corhextn_f[!rownames(corhextn_f) %in% dup, !colnames(corhextn_f) %in% dup]
row.names(corhextn_f) <- c7$Name
names(corhextn_f) <- c7$Name
colnames(corhextn_f) <- c7$Name

#draw plot
testRes = cor.mtest(corhextn_f, conf.level = 0.95)
corrplot(as.matrix(corhextn_f), 
         order = "hclust", 
         diag = F,
         addrect = 2, 
         method = "circle",
         type = "lower",
         number.cex = 0.8,
         cl.pos = 'b', 
         p.mat = testRes$p, 
         sig.level = c(0.001, 0.01, 0.05),
         insig = "label_sig",
         pch.cex = 1,
         tl.srt = 45,
         tl.col = "black",
         tl.cex = 0.8,
         col = brewer.pal(n = 10, name = 'RdYlGn'))
```