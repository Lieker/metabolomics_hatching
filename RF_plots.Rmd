---
title: "RF plots"
author: "Lieke Vlaar"
date: "06/12/2021"
output: html_document
---

Necessary packages are loaded
* ggplot2
* patchwork
* ggpmisc
* extrafont
* tidyverse
* dplyr
* plotrix
* stringr

```{r include = FALSE}
if ("knitr" %in% installed.packages()){
  library("knitr")
} else {
  install.packages("knitr")
  library("knitr")
}
```

```{r include=FALSE}
#########
# Library
#########
if ("checkpoint" %in% installed.packages()){
  library("checkpoint") # https://cran.r-project.org/web/packages/checkpoint/index.html
} else {
  install.packages("checkpoint")
  suppressPackageStartupMessages(library("checkpoint"))
  suppressPackageStartupMessages(checkpoint("2021-11-30"))  # all packages in your project will be taken from that date.
}
if ("ggplot2" %in% installed.packages()){
  library("ggplot2")
} else {
  BiocManager::install("ggplot2")
  library("ggplot2")
}
if ("patchwork" %in% installed.packages()){
  library("patchwork")
} else {
  BiocManager::install("patchwork")
  library("patchwork")
}
if ("ggpmisc" %in% installed.packages()){
  library("ggpmisc")
} else {
  BiocManager::install("ggpmisc")
  library("ggpmisc")
}
if ("extrafont" %in% installed.packages()){
  library("extrafont")
} else {
  BiocManager::install("extrafont")
  library("extrafont")
}
if ("tidyverse" %in% installed.packages()){
  library("tidyverse")
} else {
  BiocManager::install("tidyverse")
  library("tidyverse")
}
if ("dplyr" %in% installed.packages()){
  library("dplyr")
} else {
  BiocManager::install("dplyr")
  library("dplyr")
}
if ("plotrix" %in% installed.packages()){
  library("plotrix")
} else {
  BiocManager::install("plotrix")
  library("plotrix")
}
if ("stringr" %in% installed.packages()){
  library("stringr")
} else {
  BiocManager::install("stringr")
  library("stringr")
}
```

# Import data

```{r}
RF_hn <- read.csv("input/211130_VIP_regrModel_Hatching_RootExu_Neg_RF.csv", header = TRUE, fileEncoding = "UTF-8-BOM")
source("scripts/order_RF_n.R")
RF_hn <- order_RF_n1(x = RF_hn)
RF_hn2 <- order_RF_n2(x = RF_hn, y = compounds_exudate_neg, n = "output/RF_hn.csv")[,-c(4,5,8,10:15,17)]

RF_hp <- read.csv("input/211130_VIP_regrModel_Hatching_RootExu_Pos_RF.csv", header = TRUE, fileEncoding = "UTF-8-BOM")
source("scripts/order_RF_p.R")
RF_hp <- order_RF_p(x = RF_hp, y = compounds_exudate_pos[,-c(5,6,8:31)], n = "output/RF_hp.csv")

RF_sn <- read.csv("input/211130_VIP_regrModel_SolA_RootExu_Neg_RF.csv", header = TRUE, fileEncoding = "UTF-8-BOM")
RF_sn <- order_RF_n1(x = RF_sn)
RF_sn2 <- order_RF_n2(x = RF_sn, y = compounds_exudate_neg, n = "output/RF_sn.csv")[,-c(4,5,8,10:15,17)]

RF_sp <- read.csv("input/211130_VIP_regrModel_SolA_RootExu_Pos_RF.csv", header = TRUE, fileEncoding = "UTF-8-BOM")
RF_sp <- order_RF_p(x = RF_sp, y = compounds_exudate_pos[,-c(5,6,8:31)], n = "output/RF_sp.csv")
```

# Compare with Pearson's correlations

First create lists of top correlating compounds with both hatching and solA. A cut-off of the correlation coefficient of 0.25 was used.
Also, they are saved as Supplemental Table 1 (Table S1) for the manuscript.
```{r, eval = F}
source("scripts/correlationlist.R")
corr_hatching_p <- correlationlist(x = t(exudate_pos_f), interest = "hatching", mode = "+", ex = "exudate")
corr_hatching_n <- correlationlist(x = t(exudate_neg_f), interest = "hatching", mode = "-", ex = "exudate")
corr_solA_p <- correlationlist(x = t(t(exudate_pos_fr)), interest = "solA", mode = "+", ex = "exudate")
corr_solA_n <- correlationlist(x = t(t(exudate_neg_fr)), interest = "solA", mode = "-", ex = "exudate")

source("scripts/add_mz.R")
corr_solA_p <- add_mz(x = corr_solA_p, c = compounds_exudate_pos)
corr_solA_n <- add_mz(x = corr_solA_n, c = compounds_exudate_neg)
corr_hatching_p <- add_mz(x = corr_hatching_p, c = compounds_exudate_pos)
corr_hatching_n <- add_mz(x = corr_hatching_n, c = compounds_exudate_neg)
```

Then run the overlap_RF_corr function.
```{r}
source("scripts/overlap_RF_corr.R")
overlap_exups <- overlap_RF_corr(x = RF_sp, y = corr_solA_p)
overlap_exuns <- overlap_RF_corr(x = RF_sn2, y = corr_solA_n)
overlap_exuph <- overlap_RF_corr(x = RF_hp, y = corr_hatching_p)
overlap_exunh <- overlap_RF_corr(x = RF_hn2, y = corr_hatching_n)
```

# check negative with positive and vice versa

First negative RF with positive corr, then positive RF with negative corr.
```{r}
overlap_exunh_withcorrp <- overlap_RF_corr2(x = overlap_exunh, y = corr_hatching_p, yis ="p")
overlap_exuns_withcorrp <- overlap_RF_corr2(x = overlap_exuns, y = corr_solA_p, yis = "p")

overlap_exuph_withcorrn <- overlap_RF_corr2(x = overlap_exuph, y = corr_hatching_n, yis = "n")
overlap_exups_withcorrn <- overlap_RF_corr2(x = overlap_exups, y = corr_solA_n, yis = "n")
```

# Plot RF barplot

```{r, fig.width = 6, fig.height = 3.5}
source("scripts/RF_barplot.R")
r1 <- RF_barplot(x = overlap_exunh_withcorrp)
r1
r1a <- RF_barplot(x = overlap_exunh_withcorrp, hj = -0.2) + scale_y_continuous(breaks = c(0, 0.01, 0.02, 0.04), limits = c(0,0.08))
r1a
```


```{r, fig.width = 6, fig.height = 4}
source("scripts/RF_barplot.R")
r2 <- RF_barplot(x = overlap_exuph_withcorrn)
r2a <- RF_barplot(x = overlap_exuph_withcorrn, hj = -0.2)
r2 + ylim(0,0.69)
r2a + scale_y_continuous(breaks = c(0, 0.002), limits = c(0,0.014))
```

```{r, fig.height = 10, fig.width = 6}
r3 <- RF_barplot(x = overlap_exuns_withcorrp)
r3a <- RF_barplot(x = overlap_exuns_withcorrp, hj = -0.2) + ylim(0,0.01)
r3
r3a
```

```{r, fig.height = 9, fig.width = 6}
r4 <- RF_barplot(x = overlap_exups_withcorrn)
r4a <- r4 + ylim(0,0.005)
r4a 
r4
```

# Root extracts

For root extracts, only RF correlation with solA was significant after permutation, not with hatching. Therefore, we only evaluate RF correlation with solA here.

Import data:

```{r}
RF_sn_extract <- read.csv("input/211130_VIP_regrModel_SolA_RootExt_Neg_RF.csv", header = TRUE, fileEncoding = "UTF-8-BOM")
RF_sn_extract <- order_RF_n1(x = RF_sn_extract)
RF_sn_extract2 <- order_RF_n2(x = RF_sn_extract, y = compounds_extract_neg, n = "output/RF_sn_extract.csv")[,-c(4,5,8,10:15,17)]

RF_sp_extract <- read.csv("input/211130_VIP_regrModel_SolA_RootExt_Pos_RF.csv", header = TRUE, fileEncoding = "UTF-8-BOM")
RF_sp_extract <- order_RF_n1(x = RF_sp_extract)
RF_sp_extract2 <- order_RF_n2(x = RF_sp_extract, y = compounds_extract_pos, n = "output/RF_sp_extract.csv")[,-c(4,5,8,10:15,17)]
```

Compare with Pearson's correlation

```{r, eval = F}
source("scripts/correlationlist.R")
corr_solA_p_extract <- correlationlist(x = t(extract_pos_f), interest = "solA", mode = "+", ex = "extract")
corr_solA_n_extract <- correlationlist(x = t(extract_neg_f), interest = "solA", mode = "-", ex = "extract")

#Also do this for hatching, since we need it for suppl Table 1
corr_hatching_p_extract <- correlationlist(x = t(extract_pos_f), interest = "hatching", mode = "+", ex = "extract")
corr_hatching_n_extract <- correlationlist(x = t(extract_neg_f), interest = "hatching", mode = "-", ex = "extract")
```

```{r}
source("scripts/add_mz.R")
corr_solA_p_extract <- add_mz(x = corr_solA_p_extract, c = compounds_extract_pos)
corr_solA_n_extract <- add_mz(x = corr_solA_n_extract, c = compounds_extract_neg)
corr_hatching_p_extract <- add_mz(x = corr_hatching_p_extract, c = compounds_extract_pos)
corr_hatching_n_extract <- add_mz(x = corr_hatching_n_extract, c = compounds_extract_neg)
```

Then run the overlap_RF_corr function.
```{r}
source("scripts/overlap_RF_corr.R")
overlap_extps <- overlap_RF_corr(x = RF_sp_extract2, y = corr_solA_p_extract)
overlap_extns <- overlap_RF_corr(x = RF_sn_extract2, y = corr_solA_n_extract)
```

check negative with positive and vice versa
```{r}
overlap_extns_withcorrp <- overlap_RF_corr2(x = overlap_extns, y = corr_solA_p_extract, yis = "p")
overlap_extps_withcorrn <- overlap_RF_corr2(x = overlap_extps, y = corr_solA_n_extract, yis = "n")
```

Then plot bargraphs
```{r, fig.width = 7.3, fig.height = 3.5}
source("scripts/RF_barplot.R")
r5 <- RF_barplot(x = overlap_extns_withcorrp)
r5
r5a <- RF_barplot(x = overlap_extns_withcorrp, hj = -0.2) + scale_y_continuous(breaks = c(0, 0.01, 0.02, 0.04), limits = c(0,0.1))
r5a
```

```{r, fig.width = 7.3, fig.height = 10}
source("scripts/RF_barplot.R")
r6 <- RF_barplot(x = overlap_extps_withcorrn)
r6
r6a <- RF_barplot(x = overlap_extps_withcorrn, hj = -0.2) + scale_y_continuous(breaks = c(0, 0.001, 0.002, 0.003), limits = c(0,0.01))
r6a
```

